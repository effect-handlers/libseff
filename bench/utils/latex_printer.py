import sys

def format_table(results, base=None, baseVariation=None):
    baseValue = None
    if base != None:
        bases = list(filter(lambda r: r['label'] == base, results))
        if len(bases) < 1:
            sys.exit('base not found in res')
        if len(bases) > 1 and baseVariation == None:
            sys.exit('more than one base')
        bases = list(filter(lambda r: r['parameters']['variation'] == baseVariation, bases))
        if len(bases) < 1:
            sys.exit('base variation not found in res')
        if len(bases) > 1:
            sys.exit('more than one base variation')
        baseValue = bases[0]['measurement']


    header = """% Autogenerated, please don't modify
\\begin{tabular}{ | l | l | r | }
  \\hline
  Library & Variation & Mean [ms] \\\\
  \\hline
"""

    headerBase = """% Autogenerated, please don't modify
\\begin{tabular}{ | l | l | r | r | }
  \\hline
  Library & Variation & Mean [ms] & Relative \\\\
  \\hline
"""


    footer = """  \\hline
\\end{tabular}
"""

    zipped = [(r['label'], r['parameters']['variation'].replace('_', ' ').strip(), float(r['measurement']), float(r['stddev'])) for r in results]
    zipped = sorted(zipped, key=lambda x: x[2])
    res = []
    for (l, p, m, s) in zipped:
        res.append(f"  {l} & {p} & {(m * 1000):.2f} Â± {(s * 1000):.2f} " + (f"& {(m / baseValue):.2f} " if baseValue else "") + "\\\\\n")

    return (headerBase if baseValue else header) + ''.join(res) + footer
